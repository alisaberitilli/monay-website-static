<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monay API Status Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 50px;
            padding-top: 20px;
            animation: fadeInDown 0.5s ease;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 15px;
            animation: pulse 2s infinite;
        }

        .status-operational {
            background: #10b981;
            color: white;
        }

        .status-warning {
            background: #f59e0b;
            color: white;
        }

        .status-error {
            background: #ef4444;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 35px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 35px;
            margin-top: 25px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            animation: fadeInUp 0.5s ease;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .icon-api { background: #eef2ff; }
        .icon-db { background: #fef3c7; }
        .icon-app { background: #dbeafe; }
        .icon-endpoint { background: #f3e8ff; }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f9fafb;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #6b7280;
            font-weight: 500;
        }

        .info-value {
            color: #1f2937;
            font-weight: 600;
        }

        .services-grid {
            display: grid;
            gap: 15px;
        }

        
        .service-item.clickable {
            cursor: pointer;
            position: relative;
        }
        
        .service-item.clickable:hover {
            background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .service-item.clickable:active {
            transform: translateX(3px);
        }
        
        .service-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            text-decoration: none;
            color: inherit;
        }

        .service-info {
            flex: 1;
        }

        .service-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .service-url {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .service-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .status-dot.offline {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .status-dot.checking {
            background: #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .port-badge {
            background: #e5e7eb;
            color: #4b5563;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .endpoints-list {
            display: grid;
            gap: 10px;
        }



        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Blockchain Status Styles */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background-color: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .status-indicator.offline {
            background-color: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        .status-indicator.checking {
            background-color: #fbbf24;
            box-shadow: 0 0 10px #fbbf24;
        }

        .status-value {
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 10px 0;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin: 4px 0;
        }

        .stat-label span {
            color: #374151;
            font-weight: 500;
        }

        /* Stat Item Styles */
        .stat-item {
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-2px);
        }

        .stat-item h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        /* Service Grid Styles */
        .services-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .service-item {
            padding: 20px;
            background: #fafafa;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .service-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        /* Endpoints List Styles */
        .endpoints-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .endpoint-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .endpoint-item:hover {
            background: #f3f4f6;
            border-left-color: #764ba2;
            transform: translateX(5px);
        }

        /* Timestamp Styles */
        .timestamp {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Monay API Status Dashboard</h1>
            <p>Real-time monitoring of all services and endpoints</p>
            <span class="status-badge status-operational" id="mainStatus">All Systems Operational</span>
        </div>

        <div class="grid">
            <!-- API Status Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">API Status</h2>
                    <div class="card-icon icon-api">üì°</div>
                </div>
                <div id="apiInfo">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- Database Connection Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Database Connection</h2>
                    <div class="card-icon icon-db">üóÑÔ∏è</div>
                </div>
                <div id="dbInfo">
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value">Connected</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Database</span>
                        <span class="info-value">monay</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Host</span>
                        <span class="info-value">localhost:5432</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ORM</span>
                        <span class="info-value">Sequelize</span>
                    </div>
                </div>
            </div>

            <!-- System Metrics Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">System Metrics</h2>
                    <div class="card-icon icon-app">üìä</div>
                </div>
                <div id="metrics">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="metric">
                            <div class="metric-value" id="uptime">0s</div>
                            <div class="metric-label">Uptime</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="responseTime">0ms</div>
                            <div class="metric-label">Response Time</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dual-Rail Blockchain Status -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Dual-Rail Blockchain Status</h2>
                <div class="card-icon">‚õìÔ∏è</div>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <h3>Base EVM L2 (Enterprise)</h3>
                    <div id="base-status" class="status-value">
                        <span class="status-indicator" id="base-indicator">‚óè</span>
                        <span id="base-status-text">Checking...</span>
                    </div>
                    <p class="stat-label">Chain ID: <span id="base-chainid">-</span></p>
                    <p class="stat-label">Block: <span id="base-block">-</span></p>
                </div>
                <div class="stat-item">
                    <h3>Solana (Consumer)</h3>
                    <div id="solana-status" class="status-value">
                        <span class="status-indicator" id="solana-indicator">‚óè</span>
                        <span id="solana-status-text">Checking...</span>
                    </div>
                    <p class="stat-label">Network: <span id="solana-network">-</span></p>
                    <p class="stat-label">Slot: <span id="solana-slot">-</span></p>
                </div>
                <div class="stat-item">
                    <h3>Treasury Bridge</h3>
                    <div id="treasury-status" class="status-value">
                        <span class="status-indicator" id="treasury-indicator">‚óè</span>
                        <span id="treasury-status-text">Checking...</span>
                    </div>
                    <p class="stat-label">TVL: <span id="treasury-tvl">-</span></p>
                    <p class="stat-label">Pending: <span id="treasury-pending">-</span></p>
                </div>
            </div>
        </div>

        <!-- Connected Applications -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Connected Applications</h2>
                <div class="card-icon icon-app">üîó</div>
            </div>
            <div class="services-grid" id="services">
                <div class="service-item">
                    <div class="service-info">
                        <div class="service-name">Monay Website</div>
                        <div class="service-url">http://localhost:3000</div>
                    </div>
                    <div class="service-status">
                        <span class="status-dot checking" data-service="website"></span>
                        <span class="port-badge">PORT 3000</span>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-info">
                        <div class="service-name">Monay Admin Dashboard</div>
                        <div class="service-url">http://localhost:3002</div>
                    </div>
                    <div class="service-status">
                        <span class="status-dot checking" data-service="admin"></span>
                        <span class="port-badge">PORT 3002</span>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-info">
                        <div class="service-name">Monay Web App (Cross-Platform)</div>
                        <div class="service-url">http://localhost:3003</div>
                    </div>
                    <div class="service-status">
                        <span class="status-dot checking" data-service="webapp"></span>
                        <span class="port-badge">PORT 3003</span>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-info">
                        <div class="service-name">Backend API (Current)</div>
                        <div class="service-url">http://localhost:3001</div>
                    </div>
                    <div class="service-status">
                        <span class="status-dot online"></span>
                        <span class="port-badge">PORT 3001</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Endpoints -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Available API Endpoints</h2>
                <div class="card-icon icon-endpoint">üîå</div>
            </div>
            <div class="endpoints-list" id="endpoints">
                <!-- Endpoints will be loaded dynamically -->
                <div class="endpoint-item">Loading endpoints...</div>
            </div>
        </div>

        <div class="timestamp" id="timestamp">Last updated: Loading...</div>
    </div>

    <script>
        // Start an application
        async function startApplication(port, appName) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Starting...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/status/start-app', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ port: port })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    button.innerHTML = '‚úÖ Started!';
                    button.style.background = '#10b981';
                    
                    // Show success message
                    alert(`${appName} is starting on port ${port}. It may take a few seconds to become available.`);
                    
                    // Refresh the status after 3 seconds
                    setTimeout(() => {
                        fetchApplicationsStatus();
                    }, 3000);
                } else {
                    button.innerHTML = '‚ùå Failed';
                    button.style.background = '#ef4444';
                    alert(`Failed to start ${appName}: ${result.message}`);
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        button.style.background = '#10b981';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error starting application:', error);
                button.innerHTML = '‚ùå Error';
                button.style.background = '#ef4444';
                alert(`Error starting ${appName}: ${error.message}`);
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.style.background = '#10b981';
                }, 2000);
            }
        }
        
        // Update timestamp
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = 
                `Last updated: ${new Date().toLocaleString()}`;
        }

        // Format uptime
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        }

        // Fetch API info
        async function fetchAPIInfo() {
            try {
                const response = await fetch('/api/info', {
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();
                
                const apiInfoHtml = `
                    <div class="info-row">
                        <span class="info-label">Name</span>
                        <span class="info-value">${data.name}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Version</span>
                        <span class="info-value">${data.version}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value" style="color: #10b981;">${data.status}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Environment</span>
                        <span class="info-value">Development</span>
                    </div>
                `;
                document.getElementById('apiInfo').innerHTML = apiInfoHtml;
                console.log('API info loaded successfully');
            } catch (error) {
                console.error('Error fetching API info:', error);
                document.getElementById('apiInfo').innerHTML = `
                    <div class="info-row" style="color: #ef4444;">
                        <span>Error loading API status: ${error.message}</span>
                    </div>
                `;
            }
        }

        // Fetch and display applications status
        async function fetchApplicationsStatus() {
            try {
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                
                const response = await fetch('/applications', {
                    headers: { 'Accept': 'application/json' },
                    signal: controller.signal
                });
                clearTimeout(timeout);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.applications) {
                    let servicesHtml = '';
                    data.applications.forEach(app => {
                        const statusClass = app.status === 'online' ? 'online' : 
                                          app.status === 'offline' ? 'offline' : 'checking';
                        const statusIcon = app.type === 'database' ? 'üóÑÔ∏è' : 
                                         app.type === 'backend' ? '‚öôÔ∏è' : 'üåê';
                        
                        // Make frontend and backend apps clickable, but not database
                        const isClickable = app.type !== 'database';
                        const openIcon = isClickable ? 'üîó' : '';
                        
                        if (isClickable) {
                            const isOffline = app.status === 'offline';
                            const canStart = isOffline && (app.port === 3000 || app.port === 3002 || app.port === 3003);
                            
                            servicesHtml += `
                                <div class="service-item ${!isOffline ? 'clickable' : ''}" ${!isOffline ? `onclick="window.open('${app.url}', '_blank')"` : ''}>
                                    <div class="service-link">
                                        <div class="service-info">
                                            <div class="service-name">${statusIcon} ${app.displayName} ${!isOffline ? openIcon : ''}</div>
                                            <div class="service-url">${app.description}</div>
                                            <div class="service-url" style="margin-top: 3px; color: #4b5563;">
                                                ${isOffline ? 
                                                    `<span style="color: #ef4444;">Service Offline</span>` :
                                                    `<span style="text-decoration: underline;">${app.url}</span>
                                                     <span style="margin-left: 8px; opacity: 0.7;">Click to open ‚Üí</span>`
                                                }
                                            </div>
                                        </div>
                                        <div class="service-status">
                                            <span class="status-dot ${statusClass}"></span>
                                            <span class="port-badge">PORT ${app.port}</span>
                                            ${app.responseTime ? `<span style="color: #6b7280; font-size: 0.85rem;">${app.responseTime}ms</span>` : ''}
                                            ${canStart ? `
                                                <button onclick="event.stopPropagation(); startApplication(${app.port}, '${app.name}')" 
                                                        style="margin-left: 10px; padding: 4px 12px; background: #10b981; color: white; 
                                                               border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;
                                                               font-weight: 600; transition: background 0.3s ease;"
                                                        onmouseover="this.style.background='#059669'"
                                                        onmouseout="this.style.background='#10b981'">
                                                    üöÄ Start
                                                </button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            servicesHtml += `
                                <div class="service-item">
                                    <div class="service-link">
                                        <div class="service-info">
                                            <div class="service-name">${statusIcon} ${app.displayName}</div>
                                            <div class="service-url">${app.description}</div>
                                            <div class="service-url" style="margin-top: 3px; color: #6b7280;">
                                                ${app.url} (Database: ${app.database || 'monay'})
                                            </div>
                                        </div>
                                        <div class="service-status">
                                            <span class="status-dot ${statusClass}"></span>
                                            <span class="port-badge">PORT ${app.port}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    document.getElementById('services').innerHTML = servicesHtml;
                    
                    // Update main status badge
                    const onlineCount = data.onlineCount;
                    const totalCount = data.totalApplications;
                    const mainStatus = document.getElementById('mainStatus');
                    
                    if (onlineCount === totalCount) {
                        mainStatus.textContent = `All ${totalCount} Systems Operational`;
                        mainStatus.className = 'status-badge status-operational';
                    } else if (onlineCount > totalCount / 2) {
                        mainStatus.textContent = `${onlineCount}/${totalCount} Systems Online`;
                        mainStatus.className = 'status-badge status-warning';
                    } else {
                        mainStatus.textContent = `${totalCount - onlineCount} Systems Offline`;
                        mainStatus.className = 'status-badge status-error';
                    }
                    console.log(`Loaded ${data.applications.length} applications`);
                }
            } catch (error) {
                console.error('Error fetching applications status:', error);
                // Show static list as fallback
                const fallbackApps = [
                    { name: 'Monay Website', port: 3000, displayName: 'Monay Website', description: 'Public marketing website' },
                    { name: 'Backend API', port: 3001, displayName: 'Backend API', description: 'Core API services', status: 'online' },
                    { name: 'Monay Admin', port: 3002, displayName: 'Admin Dashboard', description: 'Administrative panel' },
                    { name: 'Monay Web App', port: 3003, displayName: 'Web Wallet', description: 'User wallet application' }
                ];
                
                let fallbackHtml = '';
                fallbackApps.forEach(app => {
                    const isBackend = app.port === 3001;
                    const statusClass = isBackend ? 'online' : 'checking';
                    const canStart = !isBackend;
                    
                    fallbackHtml += `
                        <div class="service-item">
                            <div class="service-link">
                                <div class="service-info">
                                    <div class="service-name">üåê ${app.displayName}</div>
                                    <div class="service-url">${app.description}</div>
                                    <div class="service-url" style="margin-top: 3px; color: #6b7280;">
                                        http://localhost:${app.port}
                                    </div>
                                </div>
                                <div class="service-status">
                                    <span class="status-dot ${statusClass}"></span>
                                    <span class="port-badge">PORT ${app.port}</span>
                                    ${canStart ? `
                                        <button onclick="event.stopPropagation(); startApplication(${app.port}, '${app.displayName}')" 
                                                style="margin-left: 10px; padding: 4px 12px; background: #10b981; color: white; 
                                                       border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;
                                                       font-weight: 600;"
                                                onmouseover="this.style.background='#059669'"
                                                onmouseout="this.style.background='#10b981'">
                                            üöÄ Start
                                        </button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('services').innerHTML = fallbackHtml;
                
                // Update status badge to show warning
                const mainStatus = document.getElementById('mainStatus');
                mainStatus.textContent = 'Status Check Failed - Showing Static List';
                mainStatus.className = 'status-badge status-warning';
            }
        }

        // Update metrics
        async function updateMetrics() {
            try {
                const healthResponse = await fetch('/health', {
                    headers: { 'Accept': 'application/json' }
                });
                const healthData = await healthResponse.json();
                
                if (healthData.uptime) {
                    document.getElementById('uptime').textContent = formatUptime(healthData.uptime);
                }
                
                // Measure response time
                const startTime = Date.now();
                await fetch('/version', {
                    headers: { 'Accept': 'application/json' }
                });
                const responseTime = Date.now() - startTime;
                document.getElementById('responseTime').textContent = `${responseTime}ms`;
            } catch (error) {
                console.error('Error updating metrics:', error);
            }
        }

        // Fetch and display API endpoints
        async function fetchEndpoints() {
            try {
                // Use XMLHttpRequest for better compatibility
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/info', false);  // Synchronous for simplicity
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.send();
                
                if (xhr.status !== 200) {
                    throw new Error('Failed to fetch API info');
                }
                
                const data = JSON.parse(xhr.responseText);
                let endpointsHtml = '';
                
                // Add basic endpoints
                if (data.endpoints) {
                    // Regular endpoints
                    for (const [key, value] of Object.entries(data.endpoints)) {
                        if (key === 'blockchain' && typeof value === 'object') {
                            // Process all blockchain endpoints
                            if (value.solana && typeof value.solana === 'object') {
                                endpointsHtml += '<div class="endpoint-item" style="background: linear-gradient(135deg, #14F195 0%, #9945FF 100%); color: white; font-weight: bold;">üöÄ Solana Consumer Rail Endpoints:</div>';
                                if (value.solana.endpoints && Array.isArray(value.solana.endpoints)) {
                                    value.solana.endpoints.forEach(endpoint => {
                                        endpointsHtml += `<div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è ${endpoint}</div>`;
                                    });
                                }
                            }
                            
                            if (value.evm && typeof value.evm === 'object') {
                                endpointsHtml += '<div class="endpoint-item" style="background: linear-gradient(135deg, #0052FF 0%, #00D4FF 100%); color: white; font-weight: bold; margin-top: 10px;">üî∑ Base L2 Enterprise Rail Endpoints:</div>';
                                if (value.evm.endpoints && Array.isArray(value.evm.endpoints)) {
                                    value.evm.endpoints.forEach(endpoint => {
                                        endpointsHtml += `<div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ ${endpoint}</div>`;
                                    });
                                }
                            }
                            
                            if (value.bridge && typeof value.bridge === 'object') {
                                endpointsHtml += '<div class="endpoint-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; margin-top: 10px;">üåâ Cross-Rail Bridge Endpoints:</div>';
                                if (value.bridge.endpoints && Array.isArray(value.bridge.endpoints)) {
                                    value.bridge.endpoints.forEach(endpoint => {
                                        endpointsHtml += `<div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ ${endpoint}</div>`;
                                    });
                                }
                            }
                            
                            if (value.status && typeof value.status === 'object') {
                                endpointsHtml += '<div class="endpoint-item" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold; margin-top: 10px;">üìä Blockchain Status Endpoints:</div>';
                                if (value.status.endpoints && Array.isArray(value.status.endpoints)) {
                                    value.status.endpoints.forEach(endpoint => {
                                        endpointsHtml += `<div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚úÖ ${endpoint}</div>`;
                                    });
                                }
                            }
                        } else if (key === 'tillipay' && typeof value === 'object') {
                            // Add TilliPay endpoints with special styling
                            endpointsHtml += '<div class="endpoint-item" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; font-weight: bold; margin-top: 10px;">üí≥ TilliPay Payment Gateway Endpoints:</div>';
                            if (value.endpoints && Array.isArray(value.endpoints)) {
                                value.endpoints.forEach(endpoint => {
                                    const status = getEndpointStatus(endpoint);
                                    endpointsHtml += `<div class="endpoint-item" style="margin-left: 20px; background: #eff6ff; padding-right: 150px;">üí∞ ${endpoint}${status}</div>`;
                                });
                            }
                        } else if (typeof value === 'string') {
                            endpointsHtml += `<div class="endpoint-item">üìå ${value}</div>`;
                        }
                    }
                }
                
                document.getElementById('endpoints').innerHTML = endpointsHtml || '<div class="endpoint-item">No endpoints available</div>';
                console.log('Endpoints loaded successfully');
                
            } catch (error) {
                console.error('Error fetching endpoints:', error);
                // Try to load basic endpoints as fallback
                const fallbackEndpoints = `
                    <div class="endpoint-item">üìå /api/auth - Authentication endpoints</div>
                    <div class="endpoint-item">üìå /api/users - User management</div>
                    <div class="endpoint-item">üìå /api/transactions - Transaction processing</div>
                    <div class="endpoint-item">üìå /api/wallet - Wallet operations</div>
                    <div class="endpoint-item">üìå /api/admin - Admin functions</div>
                    
                    <div class="endpoint-item" style="background: linear-gradient(135deg, #14F195 0%, #9945FF 100%); color: white; font-weight: bold; margin-top: 10px;">üöÄ Solana Consumer Rail Endpoints:</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è POST /api/solana/generate-wallet - Generate new Solana wallet</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è GET /api/solana/balance/:address - Get SOL balance</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è GET /api/solana/token-balance/:address/:mint - Get token balance</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è POST /api/solana/transfer-sol - Transfer SOL</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è POST /api/solana/transfer-token - Transfer SPL token</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è GET /api/solana/transactions/:address - Get transaction history</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è POST /api/solana/validate-address - Validate Solana address</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚òÄÔ∏è GET /api/solana/estimate-fee - Estimate transaction fee</div>
                    
                    <div class="endpoint-item" style="background: linear-gradient(135deg, #0052FF 0%, #00D4FF 100%); color: white; font-weight: bold; margin-top: 10px;">üî∑ Base L2 Enterprise Rail Endpoints:</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/generate-wallet - Generate EVM wallet</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/import-wallet - Import existing wallet</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ GET /api/evm/balance/:address - Get ETH/token balance</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/transfer - Transfer ETH or ERC20</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/deploy-token - Deploy ERC3643 token</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/business-rule - Create business rule</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/spend-limits - Set spend limits</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/kyc-data - Update KYC data</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ GET /api/evm/transactions/:address - Get transaction history</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/estimate-gas - Estimate gas cost</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ POST /api/evm/validate-address - Validate EVM address</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ GET /api/evm/network-status - Get network status</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üè¢ GET /api/evm/block-number - Get current block</div>
                    
                    <div class="endpoint-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; margin-top: 10px;">üåâ Cross-Rail Bridge Endpoints:</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ POST /api/bridge/swap/evm-to-solana - Swap from Base to Solana</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ POST /api/bridge/swap/solana-to-evm - Swap from Solana to Base</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ GET /api/bridge/swap/status/:swapId - Get swap status</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ GET /api/bridge/swaps/user/:userId - Get user swaps</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ POST /api/bridge/swap/cancel/:swapId - Cancel pending swap</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ GET /api/bridge/stats - Get bridge statistics</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ GET /api/bridge/config - Get bridge configuration</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f5f3ff;">üîÑ GET /api/bridge/health - Bridge health check</div>
                    
                    <div class="endpoint-item" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold; margin-top: 10px;">üìä Blockchain Status Endpoints:</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚úÖ GET /api/blockchain/health - Overall blockchain health</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚úÖ GET /api/blockchain/base/status - Base L2 status</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚úÖ GET /api/blockchain/solana/status - Solana status</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #f0fdf4;">‚úÖ GET /api/blockchain/bridge/status - Bridge status</div>
                    
                    <div class="endpoint-item" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; font-weight: bold; margin-top: 10px;">üí≥ TilliPay Payment Gateway Endpoints:</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ GET /api/tillipay/test-connection - Test TilliPay connection</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ POST /api/tillipay/payment-link - Create payment link</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ POST /api/tillipay/payment/card - Process card payment</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ POST /api/tillipay/payment/ach - Process ACH payment</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ GET /api/tillipay/payment/status/:transactionId - Get payment status</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ POST /api/tillipay/payment/refund/:transactionId - Refund payment</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ POST /api/tillipay/payment/capture/:transactionId - Capture payment</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ POST /api/tillipay/payment/void/:transactionId - Void payment</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ GET /api/tillipay/transactions - Get transaction history</div>
                    <div class="endpoint-item" style="margin-left: 20px; background: #eff6ff;">üí∞ POST /api/tillipay/webhook - Handle TilliPay webhooks</div>
                    
                    <div class="endpoint-item">üìå /status - Platform status dashboard</div>
                    <div class="endpoint-item">üìå /health - Health check</div>
                    <div class="endpoint-item">üìå /version - API version info</div>
                `;
                document.getElementById('endpoints').innerHTML = fallbackEndpoints;
            }
        }

        // Fetch blockchain status
        async function fetchBlockchainStatus() {
            // Base EVM L2 Status
            try {
                const baseResponse = await fetch('/api/blockchain/base/status');
                const baseData = await baseResponse.json();
                
                if (baseData.success) {
                    document.getElementById('base-indicator').className = 'status-indicator online';
                    document.getElementById('base-status-text').textContent = 'Operational';
                    document.getElementById('base-chainid').textContent = baseData.chainId || '84531';
                    document.getElementById('base-block').textContent = baseData.blockHeight ? baseData.blockHeight.toLocaleString() : '-';
                } else {
                    document.getElementById('base-indicator').className = 'status-indicator offline';
                    document.getElementById('base-status-text').textContent = 'Error';
                }
            } catch (error) {
                document.getElementById('base-indicator').className = 'status-indicator offline';
                document.getElementById('base-status-text').textContent = 'Offline';
                console.error('Error fetching Base status:', error);
            }

            // Solana Status
            try {
                const solanaResponse = await fetch('/api/blockchain/solana/status');
                const solanaData = await solanaResponse.json();
                
                if (solanaData.success) {
                    document.getElementById('solana-indicator').className = 'status-indicator online';
                    document.getElementById('solana-status-text').textContent = 'Operational';
                    document.getElementById('solana-network').textContent = solanaData.network || 'devnet';
                    document.getElementById('solana-slot').textContent = solanaData.slot ? solanaData.slot.toLocaleString() : '-';
                } else {
                    document.getElementById('solana-indicator').className = 'status-indicator offline';
                    document.getElementById('solana-status-text').textContent = 'Error';
                }
            } catch (error) {
                document.getElementById('solana-indicator').className = 'status-indicator offline';
                document.getElementById('solana-status-text').textContent = 'Offline';
                console.error('Error fetching Solana status:', error);
            }

            // Treasury Bridge Status
            try {
                const treasuryResponse = await fetch('/api/treasury/ledger/balance');
                const treasuryData = await treasuryResponse.json();
                
                if (treasuryData.success) {
                    document.getElementById('treasury-indicator').className = 'status-indicator online';
                    document.getElementById('treasury-status-text').textContent = 'Operational';
                    document.getElementById('treasury-tvl').textContent = treasuryData.balances?.total?.usd || '-';
                    
                    // Get pending transfers from bridge status
                    try {
                        const bridgeResponse = await fetch('/api/blockchain/bridge/status');
                        const bridgeData = await bridgeResponse.json();
                        if (bridgeData.success) {
                            const pending = (bridgeData.bridges?.baseToSolana?.pendingTransfers || 0) + 
                                          (bridgeData.bridges?.solanaToBase?.pendingTransfers || 0);
                            document.getElementById('treasury-pending').textContent = pending;
                        }
                    } catch (e) {
                        document.getElementById('treasury-pending').textContent = '0';
                    }
                } else {
                    document.getElementById('treasury-indicator').className = 'status-indicator offline';
                    document.getElementById('treasury-status-text').textContent = 'Error';
                }
            } catch (error) {
                document.getElementById('treasury-indicator').className = 'status-indicator offline';
                document.getElementById('treasury-status-text').textContent = 'Offline';
                console.error('Error fetching Treasury status:', error);
            }
        }

        // Initialize dashboard
        async function init() {
            await fetchAPIInfo();
            await updateMetrics();
            await fetchApplicationsStatus();
            await fetchEndpoints();
            await fetchBlockchainStatus();
            updateTimestamp();
        }

        // Initial load
        init();

        // Refresh every 5 seconds
        setInterval(() => {
            updateMetrics();
            fetchApplicationsStatus();
            fetchEndpoints();
            fetchBlockchainStatus();
            updateTimestamp();
        }, 5000);

        // Refresh API info every 30 seconds
        setInterval(fetchAPIInfo, 30000);
    </script>
</body>
</html>